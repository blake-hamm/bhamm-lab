name: PR Environment Deployment
on:
  pull_request:
    types: [opened, synchronize]
jobs:
  deploy-k3s-dev:
    name: Deploy k3s Dev Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Import Vault secrets
        id: import-secrets
        uses: hashicorp/vault-action@v2
        with:
          url: https://vault.vault:8200
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          tlsSkipVerify: true
          secrets: |
            secret/data/core/minio CONSOLE_ACCESS_KEY | AWS_ACCESS_KEY_ID
            secret/data/core/minio CONSOLE_SECRET_KEY | AWS_SECRET_ACCESS_KEY
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.7.1
      - name: Tofu Apply
        run: |
          tofu -chdir=tofu/proxmox/k3s init
          tofu -chdir=tofu/proxmox/k3s workspace select dev
          tofu -chdir=tofu/proxmox/k3s apply -var-file=dev.tfvars -parallelism=2 -auto-approve
