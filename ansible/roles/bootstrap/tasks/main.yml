- name: Check for vault ssh credentials
  community.hashi_vault.vault_read:
    url: https://vault.bhamm-lab.com
    auth_method: approle
    role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
    secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
    path: secret/data/core/ansible/{{ item.name }}
  with_items: "{{ bootstrap_host_list }}"
  register: host_in_vault
  ignore_errors: true
- name: Get username and password from vault
  community.hashi_vault.vault_read:
    url: https://vault.bhamm-lab.com
    auth_method: approle
    role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
    secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
    path: secret/data/core/ansible/preseed
  register: vault_preseed_secrets
  when: host_in_vault.failed
- name: Attempt to SSH into the remote host assuming vanila ssh config
  ansible.builtin.command: |
    sshpass -p "{{ vault_preseed_secrets.data.data.data.user_password }}" \
      ssh -o StrictHostKeyChecking=no \
      {{ vault_preseed_secrets.data.data.data.username }}@{{ hostvars[item.item.name].ansible_host }} \
      -p 22 "echo Connection successful"
  register: ssh_result
  ignore_errors: true
  with_items: "{{ host_in_vault.results }}"
  when: "'seem to exist' in item.msg"
  changed_when: false
- name: If no ssh, create preseed assets and exit
  ansible.builtin.include_tasks: preseed.yml
  vars:
    hostname: "{{ item.item.item.name }}"
    disk_id: "{{ item.item.item.disk_id }}"
    username: "{{ vault_preseed_secrets.data.data.data.username }}"
    user_password: "{{ vault_preseed_secrets.data.data.data.user_password }}"
  with_items: "{{ ssh_result.results}}"
  when: item.failed
- name: Retry SSH connection for 20 minutes and on success, remove preseed files
  block:
    - name: Attempt to SSH into the remote host assuming vanilla ssh config (retry)
      ansible.builtin.command: |
        sshpass -p "{{ vault_preseed_secrets.data.data.data.user_password }}" \
          ssh -o StrictHostKeyChecking=no \
          {{ vault_preseed_secrets.data.data.data.username }}@{{ hostvars[item.item.item.name].ansible_host }} \
          -p 22 "echo Connection successful"
      register: ssh_retry_result
      until: ssh_retry_result.rc == 0
      retries: 20
      delay: 60
      with_items: "{{ ssh_result.results }}"
      when: item.failed
      changed_when: false
      # always: # Remove preseed assets from pvc
- name: Debug
  ansible.builtin.debug:
    msg: "{{ item.failed }}"
  with_items: "{{ ssh_result.results }}"
  when: item.failed

# - name: If online, handler remove preseed assets from web server and run ssh hardening role
