- name: Backup current kubeconfig if backup doesn't exist
  ansible.builtin.copy:
    src: "/home/{{ ansible_user }}/.kube/config"
    dest: "/home/{{ ansible_user }}/.kube/config.bak"
    remote_src: true
    force: false
    mode: '0600'
  delegate_to: localhost
- name: Transfer file from master to nodes
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ ansible_user }}/.kube/config-temp"
    flat: true
  become: true
- name: Transfer file from master to nodes
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ ansible_user }}/.kube/config-temp"
    flat: true
  become: true
- name: Replace server address in kubeconfig
  ansible.builtin.replace:
    path: "/home/{{ ansible_user }}/.kube/config-temp"
    regexp: "server: https://127.0.0.1:6443"
    replace: 'server: https://{{ k3s_server["tls-san"] }}:6443'
  delegate_to: localhost
