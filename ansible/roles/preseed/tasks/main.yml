# - name: Try to ping server; if available, finish task
# - name: If not online, generate and serve preseed
# - name: Wait for server to be online
# - name: Once online, remove preseed assets from web server
- name: Import Vault secrets
  community.hashi_vault.vault_read:
    url: https://vault:8200
    auth_method: approle
    role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
    secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
    path: secret/data/core/ansible/preseed
    validate_certs: false
  register: vault_secrets
- name: Make sure destination dir exists
  ansible.builtin.file:
    path: "./build"
    state: directory
    mode: "0755"
- name: Generate preseed file
  ansible.builtin.template:
    src: "preseed.cfg.j2"
    dest: "./build/{{ preseed_filename }}"
    mode: "0755"
  vars:
    hostname: "{{ item.name }}"
    disk_id: "{{ item.disk_id }}"
    nic_id: "{{ item.nic_id }}"
    ip_address: "{{ item.ip_address }}"
    username: "{{ vault_secrets.data.data.data.username }}"
    user_password: "{{ vault_secrets.data.data.data.user_password }}"
  with_items: "{{ preseed_host_list }}"
