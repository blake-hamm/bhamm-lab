- name: Import Vault secrets
  community.hashi_vault.vault_read:
    url: https://vault:8200
    auth_method: approle
    role_id: "{{ lookup('env', 'VAULT_ROLE_ID') }}"
    secret_id: "{{ lookup('env', 'VAULT_SECRET_ID') }}"
    path: secret/data/core/ansible/preseed
    validate_certs: false
- name: Make sure destination dir exists
  ansible.builtin.file:
    path: "./build"
    state: directory
    mode: "0755"
- name: Generate preseed file
  ansible.builtin.template:
    src: "preseed.cfg.j2"
    dest: "./build/{{ preseed_filename }}"
    mode: "0755"
  vars:
    hostname: "{{ item.key }}"
    disk_id: "{{ item.value }}"
    username: test
    # username: "{{ vault_secrets.data.username }}"
    user_password: password
    # user_password: "{{ vault_secrets.data.user_password }}"
  with_dict: "{{ preseed_hostname_disk_id_map }}"
