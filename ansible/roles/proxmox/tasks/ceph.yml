- name: Check if OSD devices or partitions are mounted
  ansible.builtin.shell: |
    lsblk -no MOUNTPOINT "{{ item.device }}"
  register: lsblk_mount_check
  changed_when: false
  loop: "{{ pve_ceph_osds }}"
  loop_control:
    label: "{{ item.device }}"
- name: Fail if any OSD device is mounted
  ansible.builtin.fail:
    msg: "Device {{ item.item.device }} or its partitions are mounted. Mount points: {{ item.stdout_lines | join(', ') }}"
  when: item.stdout != ''
  loop: "{{ lsblk_mount_check.results }}"
  loop_control:
    label: "{{ item.item.device }}"
- name: Wipe all existing signatures on OSD devices
  ansible.builtin.command: wipefs --all "{{ item.device }}"
  changed_when: "'erased' in wipefs_result.stdout"
  register: wipefs_result
  loop: "{{ pve_ceph_osds }}"
  loop_control:
    label: "{{ item.device }}"
