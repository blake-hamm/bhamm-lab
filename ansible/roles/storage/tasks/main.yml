# tasks/storage.yml
- name: Rename volume group
  community.general.lvg_rename:
    vg: "{{ ansible_hostname }}-vg"
    vg_new: local-vg
  notify: Reload udev and devices
- name: Ensure old LV symlink exists for grub-probe
  ansible.builtin.file:
    src: "/dev/mapper/local--vg-root"
    path: "/dev/mapper/{{ ansible_hostname }}--vg-root"
    state: link
  notify: Reload udev and devices
- name: Trigger udev to recognize new device names
  ansible.builtin.command:
    cmd: udevadm trigger --action=change --type=devices --subsystem-match=block
  changed_when: false
- name: Resize root LV to 100GB
  community.general.lvol:
    vg: local-vg
    lv: root
    size: 100g
    resizefs: true
- name: Resize swap LV to 4GB
  community.general.lvol:
    vg: local-vg
    lv: swap_1
    size: 4g
    force: true
- name: Update /etc/fstab root entry
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: "{{ storage_old_root | regex_escape }}"
    replace: "{{ storage_new_root }}"
  notify: Update fstab and GRUB
- name: Update /etc/fstab swap entry
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: "{{ storage_old_swap | regex_escape }}"
    replace: "{{ storage_new_swap }}"
  notify: Update fstab and GRUB
- name: Ensure resume hook points to new swap LV
  ansible.builtin.copy:
    dest: /etc/initramfs-tools/conf.d/resume
    content: |
      RESUME={{ storage_new_swap }}
    owner: root
    group: root
    mode: '0644'
  notify: Update initramfs
- name: Set GRUB_CMDLINE_LINUX to include new root LV
  ansible.builtin.replace:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX="(.+)"'
    replace: 'GRUB_CMDLINE_LINUX="root={{ storage_new_root }} \1"'
  notify: Update fstab and GRUB
- name: Extra config for Proxmox storage
  ansible.builtin.include_tasks:
    file: proxmox.yml
  when: "'proxmox' in group_names"
