- name: Create logical volume for VM storage
  community.general.lvol:
    vg: "{{ ansible_hostname }}-vg"
    lv: vmstore
    size: 800g
    resizefs: true
- name: Format the logical volume with ext4
  community.general.filesystem:
    fstype: ext4
    dev: "/dev/{{ ansible_hostname }}-vg/vmstore"
- name: Create the mount point directory
  ansible.builtin.file:
    path: /mnt/vmstore
    state: directory
    mode: '0755'
- name: Mount the logical volume
  ansible.posix.mount:
    path: /mnt/vmstore
    src: "/dev/{{ ansible_hostname }}-vg/vmstore"
    fstype: ext4
    state: mounted
    opts: defaults
- name: Ensure volume is persistent on boot
  ansible.posix.mount:
    path: /mnt/vmstore
    src: "/dev/{{ ansible_hostname }}-vg/vmstore"
    fstype: ext4
    opts: defaults
    state: present
- name: Install parted package
  ansible.builtin.package:
    name: parted
    state: present
    update_cache: true
- name: Create Ceph DB/WAL partitions
  community.general.parted:
    device: "{{ ceph_nvme_device }}"
    number: "{{ item.number }}"
    name: "{{ item.name }}"
    part_start: "{{ item.start }}"
    part_end: "{{ item.end }}"
    label: gpt
    align: optimal
    unit: GiB
    state: "{{ item.state | default('present') }}"
  loop: "{{ ceph_partitions }}"
