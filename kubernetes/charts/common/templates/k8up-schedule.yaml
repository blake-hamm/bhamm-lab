{{- if .Values.k8up.backup.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: {{ .Values.name }}-onsite-backup
  namespace: {{ .Values.name }}
  annotations:
    argocd.argoproj.io/sync-wave: "25"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  schedule: "{{ .Values.k8up.backup.schedule }}"
  timezone: America/Denver
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  workflowSpec:
    entrypoint: main
    templates:
      - name: main
        steps:
          - - name: full-k8up-backup
              templateRef:
                name: manage-k8up
                template: full-k8up-backup
                clusterScope: true
              arguments:
                parameters:
                  - name: target-namespace
                    value: {{ .Values.name }}
                  - name: location
                    value: onsite
                  - name: k8up-endpoint
                    value: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
                  - name: k8up-bucket
                    value: k8up-backups
                  - name: k8up-secret
                    value: k8up
{{- end }}