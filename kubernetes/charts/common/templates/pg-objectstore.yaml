{{- if or .Values.postgresql.backups.enabled .Values.postgresql.restore.enabled }}
apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: {{ .Values.name}}-cnpg-ceph
  namespace: {{ .Values.name }}
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "15"
spec:
  configuration:
    destinationPath: "s3://cnpg-backups/{{ .Values.name }}"
    endpointURL: http://rgw.ceph.svc.cluster.local:7480
    s3Credentials:
      accessKeyId:
        name: cnpg-s3-backup-creds
        key: access_key
      secretAccessKey:
        name: cnpg-s3-backup-creds
        key: secret_key
    retentionPolicy: "{{ .Values.postgresql.backups.retention }}"
    data:
      additionalCommandArgs:
        - "--read-timeout=600"
        - "--write-timeout=600"
        - "--retry-times=10"
        - "--retry-delay=10"
        - "--min-chunk-size=5MB"
        - "--max-archive-size=1GB"
        - "-v"
    wal:
      additionalCommandArgs:
        - "--read-timeout=300"
        - "--write-timeout=300"
        - "--retry-times=5"
{{- end }}