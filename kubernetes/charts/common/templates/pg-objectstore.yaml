{{- if .Values.postgresql.backup.enabled }}
apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: {{ .Values.name }}-backup
  namespace: {{ .Values.name }}
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "15"
spec:
  configuration:
    destinationPath: "{{ .Values.postgresql.basePath }}/{{ .Values.postgresql.backup.pathVersion }}/"
    endpointURL: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
    s3Credentials:
      accessKeyId:
        name: cnpg-s3-backup-creds
        key: access_key
      secretAccessKey:
        name: cnpg-s3-backup-creds
        key: secret_key
    wal:
      maxParallel: 1
    data:
      jobs: 1
  retentionPolicy: "{{ .Values.postgresql.backup.retention }}"
  instanceSidecarConfiguration:
    resources:
      limits:
        memory: 500Mi
---
{{- end }}
{{- if .Values.postgresql.restore.enabled }}
apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: {{ .Values.name }}-restore
  namespace: {{ .Values.name }}
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "15"
spec:
  configuration:
    destinationPath: "{{ .Values.postgresql.basePath }}/{{ .Values.postgresql.restore.pathVersion }}/"
    endpointURL: http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333
    s3Credentials:
      accessKeyId:
        name: cnpg-s3-backup-creds
        key: access_key
      secretAccessKey:
        name: cnpg-s3-backup-creds
        key: secret_key
    wal:
      maxParallel: 1
    data:
      jobs: 1
  retentionPolicy: "{{ .Values.postgresql.restore.retention }}"
  instanceSidecarConfiguration:
    resources:
      limits:
        memory: 500Mi
{{- end }}