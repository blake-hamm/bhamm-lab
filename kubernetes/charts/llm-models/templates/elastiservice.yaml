{{- range .Values.models }}
{{- $merged := mergeOverwrite (deepCopy $.Values.global) . -}}
{{- if and .enabled $merged.zeroscaling.enabled }}
apiVersion: elasti.truefoundry.com/v1alpha1
kind: ElastiService
metadata:
  name: {{ .name }}
  namespace: {{ $merged.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "25"
  labels:
    app: {{ .name }}
    release: {{ $.Release.Name }}
spec:
  minTargetReplicas: {{ $merged.zeroscaling.minReplicas }}
  service: {{ .name }}
  cooldownPeriod: {{ $merged.zeroscaling.cooldownPeriod }}
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .name }}
  triggers:
    - type: prometheus
      metadata:
        query: {{ tpl $merged.zeroscaling.trigger.query $ }}
        serverAddress: http://monitor-prometheus.monitor.svc.cluster.local:9090
        threshold: "{{ $merged.zeroscaling.trigger.threshold }}"
{{- end }}
{{- end }}