{{- range .Values.models }}
{{- if and .enabled (coalesce (default dict .zeroscaling).enabled $.Values.global.zeroscaling.enabled) }}
apiVersion: elasti.truefoundry.com/v1alpha1
kind: ElastiService
metadata:
  name: {{ .name }}
  namespace: {{ $.Values.global.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "25"
  labels:
    app: {{ .name }}
    release: {{ $.Release.Name }}
spec:
  minTargetReplicas: {{ coalesce .zeroscaling.minReplicas $.Values.global.zeroscaling.minReplicas }}
  service: {{ .name }}
  cooldownPeriod: {{ coalesce .zeroscaling.cooldownPeriod $.Values.global.zeroscaling.cooldownPeriod }}
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .name }}
  triggers:
    - type: prometheus
      metadata:
        query: {{ tpl (coalesce (default dict (default dict .zeroscaling).trigger).query $.Values.global.zeroscaling.trigger.query) . }}
        serverAddress: http://monitor-prometheus.monitor.svc.cluster.local:9090
        threshold: "{{ coalesce (default dict (default dict .zeroscaling).trigger).threshold $.Values.global.zeroscaling.trigger.threshold }}"
{{- end }}
{{- end }}