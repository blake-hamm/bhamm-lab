apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: open-webui
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "26"
spec:
  destination:
    namespace: open-webui
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: open-webui
    repoURL: https://helm.openwebui.com
    targetRevision: 8.12.2
    helm:
      valuesObject:
        ollama:
          enabled: false
        ollamaUrls: []
        pipelines:
          enabled: true
          extraEnvVars: []
        strategy: {}
        livenessProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 1
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health/db
            port: http
          failureThreshold: 1
          periodSeconds: 10
        startupProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          failureThreshold: 20
        persistence:
          enabled: true
          existingClaim: "open-webui-data"
          provider: local
        tolerations:
          - key: "amd.com/gpu"
            operator: "Exists"
            effect: "NoSchedule"
        extraEnvVars:
          - name: OPENAI_API_KEY
            valueFrom:
              secretKeyRef:
                name: open-webui-external-secret
                key: OPENAI_API_KEY
          - name: OPENAI_API_BASE_URL
            value: "http://litellm.litellm.svc.cluster.local:4000/v1"
          - name: DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: open-webui-postgresql-app
                key: uri
          - name: ENABLE_LOGIN_FORM
            value: "False"
        enableOpenaiApi: true
        sso:
          enabled: true
          enableSignup: true
          mergeAccountsByEmail: true
          enableRoleManagement: true
          enableGroupManagement: true
          oidc:
            enabled: true
            clientId: "open-webui"
            clientSecret: ""
            clientExistingSecret: "open-webui-external-secret"
            clientExistingSecretKey: "OAUTH_CLIENT_SECRET"
            providerUrl: "https://auth.bhamm-lab.com/.well-known/openid-configuration"
            providerName: "Authelia"
            scopes: "openid email profile groups"
          roleManagement:
            rolesClaim: "groups"
            allowedRoles: "user,admin"
            adminRoles: "admin"
          groupManagement:
            groupsClaim: "groups"
  syncPolicy:
    syncOptions:
      - ApplyOutOfSyncOnly=true
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 10
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 10m
