apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: forgejo-docker-changes
  namespace: argo
  annotations:
    argocd.argoproj.io/sync-wave: "7"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  template:
    serviceAccountName: argo-workflow
  dependencies:
    - name: forgejo-push-event
      eventSourceName: forgejo
      eventName: push
      filters:
        script: |-
          -- Check all commits for docker/ path changes
          for _, commit in ipairs(event.body.commits) do
              -- Check added files
              for _, path in ipairs(commit.added) do
                  if string.sub(path, 1, 7) == "docker/" then
                      return true
                  end
              end

              -- Check modified files
              for _, path in ipairs(commit.modified) do
                  if string.sub(path, 1, 7) == "docker/" then
                      return true
                  end
              end

              -- Check removed files
              for _, path in ipairs(commit.removed) do
                  if string.sub(path, 1, 7) == "docker/" then
                      return true
                  end
              end
          end
          return false
  triggers:
    - template:
        name: docker-change-trigger
        argoWorkflow:
          operation: submit
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: forgejo-docker-changes-
              spec:
                serviceAccountName: argo-workflow
                entrypoint: main
                onExit: exit-handler
                volumeGC:
                  strategy: OnWorkflowCompletion
                volumeClaimTemplates:
                  - metadata:
                      name: docker-workspace
                    spec:
                      accessModes: ["ReadWriteOnce"]
                      resources:
                        requests:
                          storage: 1Gi
                arguments:
                  parameters:
                    - name: commits
                    - name: repoUrl
                    - name: branch
                    - name: git-sha
                templates:
                  - name: main
                    inputs:
                      parameters:
                        - name: commits
                        - name: repoUrl
                        - name: branch
                        - name: git-sha
                    dag:
                      tasks:
                        - name: forgejo-status
                          templateRef:
                            name: forgejo-status
                            template: forgejo-status
                          arguments:
                            parameters:
                              - name: git-sha
                                value: "{{inputs.parameters.git-sha}}"
                              - name: state
                                value: "pending"
                        - name: extract-dockerfiles
                          template: extract-dockerfiles
                          arguments:
                            parameters:
                              - name: commits
                                value: "{{inputs.parameters.commits}}"
                        - name: clone-repo
                          template: clone-repo
                          arguments:
                            parameters:
                              - name: url
                                value: "{{inputs.parameters.repoUrl}}"
                              - name: branch
                                value: "{{inputs.parameters.branch}}"
                        - name: prepare-config
                          template: prepare-docker-config
                          depends: "clone-repo"
                        - name: build-and-push
                          template: build-and-push-buildkit
                          depends: "extract-dockerfiles && clone-repo && prepare-config"
                          arguments:
                            parameters:
                              - name: dockerfile
                                value: "{{item}}"
                          withParam: "{{tasks.extract-dockerfiles.outputs.result}}"
                  - name: clone-repo
                    inputs:
                      parameters:
                        - name: url
                        - name: branch
                    container:
                      image: alpine/git:v2.26.2
                      command: [git, clone]
                      args:
                        - --recurse-submodules
                        - --branch
                        - "{{inputs.parameters.branch}}"
                        - --single-branch
                        - --depth
                        - "1"
                        - "{{inputs.parameters.url}}"
                        - .
                      workingDir: /workspace
                      volumeMounts:
                        - name: docker-workspace
                          mountPath: /workspace
                  - name: extract-dockerfiles
                    inputs:
                      parameters:
                        - name: commits
                      artifacts:
                        - name: input-json
                          path: /tmp/input.json
                          raw:
                            data: "{{inputs.parameters.commits}}"
                    script:
                      image: python:alpine
                      command: [python]
                      source: |
                        import json
                        import os

                        with open('/tmp/input.json', 'r') as f:
                            commits = json.load(f)

                        docker_files = []
                        for commit in commits:
                            for path in commit.get('added', []) + commit.get('modified', []):
                                parts = path.split('/')
                                if len(parts) >= 2 and parts[0] == 'docker':
                                    dir_name = parts[1]
                                    dockerfile_path = os.path.join('docker', dir_name, 'Dockerfile')
                                    if dockerfile_path not in docker_files:
                                        docker_files.append(dockerfile_path)

                        print(json.dumps(docker_files))
                  - name: prepare-docker-config
                    script:
                      image: alpine:latest
                      command: [sh]
                      volumeMounts:
                        - name: docker-workspace
                          mountPath: /workspace
                      env:
                        - name: REGISTRY
                          value: "harbor.bhamm-lab.com"
                        - name: ROBOT_USERNAME
                          valueFrom:
                            secretKeyRef:
                              name: argo-external-secret
                              key: robot-username
                        - name: ROBOT_TOKEN
                          valueFrom:
                            secretKeyRef:
                              name: argo-external-secret
                              key: robot-token
                      source: |
                        #!/bin/sh
                        set -e
                        DOCKER_DIR="/workspace/.docker"
                        mkdir -p ${DOCKER_DIR}
                        echo '{
                          "auths": {
                            "'"${REGISTRY}"'": {
                              "auth": "'"$(echo -n "${ROBOT_USERNAME}:${ROBOT_TOKEN}" | base64)"'"
                            }
                          }
                        }' > ${DOCKER_DIR}/config.json
                  - name: build-and-push-buildkit
                    inputs:
                      parameters:
                        - name: dockerfile
                    container:
                      volumeMounts:
                        - name: docker-workspace
                          mountPath: /workspace
                      securityContext:
                        allowPrivilegeEscalation: false
                        runAsNonRoot: true
                        runAsUser: 1000
                        capabilities:
                          drop:
                            - ALL
                        seccompProfile:
                          type: RuntimeDefault
                      readinessProbe:
                        exec:
                          command: [sh, -c, "buildctl debug workers"]
                        initialDelaySeconds: 5
                        periodSeconds: 30
                      image: moby/buildkit:v0.9.3-rootless
                      command: ["/bin/sh", "-c"]
                      env:
                        - name: BUILDKITD_FLAGS
                          value: --oci-worker-no-process-sandbox
                        - name: DOCKER_CONFIG
                          value: /workspace/.docker
                      args:
                        - |
                          set -ex

                          DOCKERFILE_PATH="{{inputs.parameters.dockerfile}}"
                          full_path="/workspace/$DOCKERFILE_PATH"
                          context_dir=$(dirname "$full_path")
                          image_name=$(basename "$context_dir")
                          IMAGE_TAG="harbor.bhamm-lab.com/library/$image_name:latest"

                          buildctl-daemonless.sh build \
                            --frontend dockerfile.v0 \
                            --local "context=$context_dir" \
                            --local "dockerfile=$context_dir" \
                            --output "type=image,name=$IMAGE_TAG,push=true"
                  - name: exit-handler
                    steps:
                      - - name: final-status
                          templateRef:
                            name: forgejo-status
                            template: forgejo-status
                          arguments:
                            parameters:
                              - name: git-sha
                                value: "{{workflow.parameters.git-sha}}"
                              - name: state
                                value: "{{=workflow.status == 'Succeeded' ? 'success' : 'failure'}}"
          parameters:
            - src:
                dependencyName: forgejo-push-event
                dataKey: body.commits
              dest: spec.arguments.parameters.0.value
              transformation:
                template: "{{ .Input | toJson }}"
            - src:
                dependencyName: forgejo-push-event
                dataKey: body.repository.clone_url
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: forgejo-push-event
                dataKey: body.ref
                transformation:
                  template: '{{ .Input | replace "refs/heads/" "" }}'
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: forgejo-push-event
                dataKey: body.head_commit.id
              dest: spec.arguments.parameters.3.value
