apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
commonNamespace: amd
commonAnnotations:
  argocd.argoproj.io/sync-wave: "2"
resources:
  - https://raw.githubusercontent.com/ROCm/k8s-device-plugin/master/k8s-ds-amdgpu-dp-health.yaml
  - https://raw.githubusercontent.com/ROCm/k8s-device-plugin/master/k8s-ds-amdgpu-labeller.yaml
patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: DaemonSet
      name: amdgpu-device-plugin-daemonset
    patch: |-
      [
        {
          "op": "replace",
          "path": "/spec/template/spec/nodeSelector",
          "value": {
            "feature.node.kubernetes.io/pci-0380_1002.present": "true"
          }
        },
        {
          "op": "replace",
          "path": "/spec/template/spec/tolerations",
          "value": [
            {
              "key": "amd.com/gpu",
              "operator": "Exists",
              "effect": "NoSchedule"
            }
          ]
        }
      ]
  - target:
      group: apps
      version: v1
      kind: DaemonSet
      name: amdgpu-labeller-daemonset
    patch: |-
      [
        {
          "op": "replace",
          "path": "/spec/template/spec/nodeSelector",
          "value": {
            "feature.node.kubernetes.io/pci-0380_1002.present": "true"
          }
        },
        {
          "op": "replace",
          "path": "/spec/template/spec/tolerations",
          "value": [
            {
              "key": "amd.com/gpu",
              "operator": "Exists",
              "effect": "NoSchedule"
            }
          ]
        }
      ]
