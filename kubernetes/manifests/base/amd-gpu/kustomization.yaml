apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: amd
resources:
  - https://raw.githubusercontent.com/ROCm/k8s-device-plugin/v1.31.0.8/k8s-ds-amdgpu-dp-health.yaml
  - https://raw.githubusercontent.com/ROCm/k8s-device-plugin/v1.31.0.8/k8s-ds-amdgpu-labeller.yaml
patchesJson6902:
  - target:
      group: apps
      version: v1
      kind: DaemonSet
      name: amdgpu-device-plugin-daemonset
    patch: |-
      [
        {
          "op": "replace",
          "path": "/spec/template/spec/containers/0/image",
          "value": "rocm/k8s-device-plugin:1.31.0.8"
        },
        {
          "op": "replace",
          "path": "/spec/template/spec/nodeSelector",
          "value": {
            "feature.node.kubernetes.io/pci-0380_1002.present": "true"
          }
        },
        {
          "op": "replace",
          "path": "/spec/template/spec/tolerations",
          "value": [
            {
              "key": "amd.com/gpu",
              "operator": "Exists",
              "effect": "NoSchedule"
            }
          ]
        }
      ]
  - target:
      group: apps
      version: v1
      kind: DaemonSet
      name: amdgpu-labeller-daemonset
    patch: |-
      [
        {
          "op": "replace",
          "path": "/spec/template/spec/containers/0/image",
          "value": "rocm/k8s-device-plugin:labeller-1.31.0.8"
        },
        {
          "op": "replace",
          "path": "/spec/template/spec/nodeSelector",
          "value": {
            "feature.node.kubernetes.io/pci-0380_1002.present": "true"
          }
        },
        {
          "op": "replace",
          "path": "/spec/template/spec/tolerations",
          "value": [
            {
              "key": "amd.com/gpu",
              "operator": "Exists",
              "effect": "NoSchedule"
            }
          ]
        }
      ]
