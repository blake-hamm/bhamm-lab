# Call 'full-k8up-restore' in seaweedfs namespace template in manage-k8up cluster workflow template.
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: seaweedfs-restore-all
  namespace: seaweedfs
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/sync-wave: "3"
spec:
  entrypoint: main
  templates:
    - name: main
      retryStrategy:
        limit: 3
        backoff:
          duration: "10s"
          factor: 2
          maxDuration: "30s"
      steps:
        - - name: disable-base-argocd-autosync
            template: disable-argocd-autosync
            arguments:
              parameters:
                - name: argocd-app
                  value: "green-base"
        - - name: full-k8up-restore
            templateRef:
              name: manage-k8up
              template: full-k8up-restore
              clusterScope: true
            arguments:
              parameters:
                - name: target-namespace
                  value: seaweedfs
                - name: location
                  value: onsite
                - name: k8up-endpoint
                  value: http://10.0.20.199:9000 # Minio through truenas
                - name: k8up-bucket
                  value: seaweedfs
                - name: k8up-secret
                  value: seaweedfs-external-secret
        - - name: enable-base-argocd-autosync
            template: enable-argocd-autosync
            arguments:
              parameters:
                - name: argocd-app
                  value: "green-base"
    - name: disable-argocd-autosync
      inputs:
        parameters:
          - name: argocd-app
      resource:
        action: patch
        mergeStrategy: merge
        manifest: |
          spec:
            syncPolicy: null
        flags:
          - applications.argoproj.io
          - "{{inputs.parameters.argocd-app}}"
          - -n
          - argocd
    - name: enable-argocd-autosync
      inputs:
        parameters:
          - name: argocd-app
      resource:
        action: patch
        mergeStrategy: merge
        manifest: |
          spec:
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
        flags:
          - applications.argoproj.io
          - "{{inputs.parameters.argocd-app}}"
          - -n
          - argocd
