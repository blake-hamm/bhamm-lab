apiVersion: argoproj.io/v1alpha1
kind: Workflow #CronWorkflow
metadata:
  name: test-timestamp-updater
  namespace: test
spec:
  schedule: "0 */6 * * *"
  concurrencyPolicy: Replace
  workflowSpec:
    entrypoint: update-timestamp
    templates:
      - name: update-timestamp
        container:
          image: bitnami/kubectl:latest
          command: [bash, -c]
          args:
            - |
              set -euo pipefail

              # find the running nginx pod
              pod=$(kubectl get pods -n test -l app=test \
                    --field-selector=status.phase=Running \
                    -o jsonpath='{.items[0].metadata.name}')

              # pull out up to 9 existing timestamps, strip <li>â€¦</li>
              old_ts=$(kubectl exec -n test "$pod" -- \
                grep -oP '(?<=<li>).*?(?=</li>)' \
                /usr/share/nginx/html/index.html \
                | head -n9 || true)

              # generate full HTML and write it back
              kubectl exec -i -n test "$pod" -- tee /usr/share/nginx/html/index.html >/dev/null <<EOF
              <html>
              <head><title>Last Update Timestamps</title></head>
              <body>
                <h1>Last 10 Update Timestamps (UTC):</h1>
                <ul>
                  <li>$(date -u +'%Y-%m-%d %T UTC')</li>
              $(echo "$old_ts" | awk '{printf "                <li>%s</li>\n", $0}')
                </ul>
              </body>
              </html>
              EOF

              echo "index.html updated on $(date -u +'%Y-%m-%d %T UTC')"
