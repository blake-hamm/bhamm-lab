apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: cluster-kill-switch-template
spec:
  templates:
    - name: cleanup
      steps:
        - - name: pause-argocd-apps
            template: pause-apps
        - - name: delete-pvcs
            template: delete-pvcs
        - - name: remove-pvc-finalizers
            template: remove-finalizers
        - - name: delete-argocd-apps
            template: delete-apps
    - name: pause-apps
      script:
        image: bitnami/kubectl
        command: [bash]
        source: |
          # Pause all ArgoCD applications to stop syncing
          kubectl get applications -n argocd -o name | xargs -I {} kubectl patch {} -n argocd --type merge -p '{"spec":{"syncPolicy":{"automated":null}}}'
    - name: delete-pvcs
      script:
        image: bitnami/kubectl
        command: [bash]
        source: |
          # Delete all PVCs in all namespaces
          kubectl delete pvc --all --all-namespaces --force --grace-period=0
    - name: remove-finalizers
      script:
        image: bitnami/kubectl
        command: [bash]
        source: |
          # Remove finalizers from any PVCs stuck in terminating state across all namespaces
          for ns in $(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}'); do
            for pvc in $(kubectl get pvc -n $ns -o jsonpath='{.items[?(@.status.phase=="Terminating")].metadata.name}' 2>/dev/null); do
              kubectl patch pvc $pvc -n $ns -p '{"metadata":{"finalizers":[]}}' --type=merge
            done
          done
    - name: delete-apps
      script:
        image: bitnami/kubectl
        command: [bash]
        source: |
          # Delete all ArgoCD applications to remove managed resources
          kubectl delete applications --all -n argocd --force --grace-period=0
